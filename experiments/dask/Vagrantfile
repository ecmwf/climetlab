# brew install qemu vagrant
# On MAC M1:
#     vagrant plugin install vagrant-qemu
#     vagrant up --provider=qemu
# Elsewhere:
#     vagrant up --provider=virtualbox
# vagrant ssh-config > ~/.ssh/vagrant_ssh_config

Vagrant.configure(2) do |config|
  config.vm.box = "generic/ubuntu2204"
  # config.vm.box_version = "4.1.4"
  config.vm.synced_folder ".", "/vagrant", disabled: true

  # config.vm.define "abc"
  # config.vm.hostname = "abc"

  config.vm.provision "file", source: "~/.cdsapirc", destination: ".cdsapirc"
  config.vm.provision "file", source: "~/.ecmwfapirc", destination: ".ecmwfapirc"

  (0..3).each do |i|
    config.vm.define "node#{i}" do |node|

      node.vm.hostname = "node#{i}"

      node.vm.provision "shell" do |s|
        s.path = "provision.sh"
        s.args = [i]
      end

      node.vm.provider "qemu" do |qe|
        qe.memory = "2G"
        qe.arch = "x86_64"
        qe.machine = "q35"
        qe.cpu = "max"
        qe.net_device = "virtio-net-pci"
        qe.ssh_port = 5022 + i
      end
      # node.vm.network :private_network, ip: "192.168.56.#{100 + i}"

      # Host IP address is 10.0.2.2
      if (i == 0)
        node.vm.network :forwarded_port, guest: 8786, host: 8786 # scheduler
        node.vm.network :forwarded_port, guest: 8787, host: 8787 # dashboard
        node.vm.network :forwarded_port, guest: 18786, host: 18786 # scheduler
        node.vm.network :forwarded_port, guest: 18787, host: 18787 # dashboard
      end
    end
  end
end
